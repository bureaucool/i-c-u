<script lang="ts">
	import TaskItem from '$lib/components/task-item.svelte';
	import type { Task, User } from '$lib/types';
	import TaskDialog from '$lib/components/task-dialog.svelte';
	import TreatDialog from '$lib/components/treat-dialog.svelte';
	import { invalidateAll } from '$app/navigation';
	import Button from '$lib/components/button.svelte';

	let {
		data
	}: {
		data: {
			user?: { id: number; name: string } | null;
			tasks?: Task[];
			activeTasks?: Task[];
			completedTasks?: Task[];
			users?: User[];
			pendingTreats?: import('$lib/types').Treat[];
		};
	} = $props();

	let showAdd = $state(false);
	let formType: 'task' | 'treat' = $state('task');
	let loginMsg = $state<string | null>(null);
	let loginErr = $state<string | null>(null);
	let addMsg = $state<string | null>(null);
	let addErr = $state<string | null>(null);
	// Floating treat accept flow state
	let acceptingTreatId: number | null = $state(null);
	let acceptMinutes: number | null = $state(null);
	let acceptFeedback: string = $state('');

	let title = $state<string | null>(null);
	let emoji = $state<string | null>('');
	let selectableEmojis = $state<string[]>([]);
	let showPicker = $state(false);

	// Overlays for complete/edit
	let completeOpen = $state(false);
	let editOpen = $state(false);
	let selectedTask: Task | null = $state(null);
	let completeMinutes = $state<number | null>(null);
	// Edit state (reuses add fields)
	let editTitle = $state<string>('');
	let editEmoji = $state<string>('');
	let editAssignedUserId = $state<string>('');
	let editDate = $state<string>('');
	let editTime = $state<string>('');
	let editRecurrenceType = $state<string>('');
	let editRecurrenceInterval = $state<string>('');

	const now = new Date();
	const startOfDay = new Date(now.getFullYear(), now.getMonth(), now.getDate()).getTime();
	const endOfDay = startOfDay + 24 * 60 * 60 * 1000 - 1;

	const tasksToday = $derived(
		(data.activeTasks ?? data.tasks ?? []).filter((t) => {
			const ts = Number(t.scheduledAt ?? 0);
			return ts >= startOfDay && ts <= endOfDay;
		})
	);
	const tasksUpcoming = $derived(
		(data.activeTasks ?? data.tasks ?? []).filter((t) => {
			const ts = Number(t.scheduledAt ?? 0);
			return ts > endOfDay;
		})
	);
	const tasksNoDate = $derived(
		(data.activeTasks ?? data.tasks ?? []).filter((t) => t.scheduledAt == null)
	);

	function openComplete(t: Task) {
		selectedTask = t;
		completeMinutes = Number((t as any).durationMinutes ?? '') || null;
		completeOpen = true;
	}

	function openEdit(t: Task) {
		showAdd = true;
		selectedTask = t;
		editTitle = t.title ?? '';
		editEmoji = (t.emoji ?? '') as string;
		editAssignedUserId = t.assignedUserId ? String(t.assignedUserId) : '';
		if (t.scheduledAt) {
			const d = new Date(Number(t.scheduledAt));
			editDate = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
			editTime = `${String(d.getHours()).padStart(2, '0')}:${String(d.getMinutes()).padStart(2, '0')}`;
		} else {
			editDate = '';
			editTime = '';
		}
		editRecurrenceType = ((t as any).recurrenceType ?? '') as string;
		editRecurrenceInterval =
			((t as any).recurrenceInterval ?? '') ? String((t as any).recurrenceInterval) : '';
		editOpen = true;
	}
</script>

{#if !data.user}
	<div class="fixed top-3 right-3">
		<div class="flex flex-col gap-y-2">
			<form
				class="flex flex-col gap-y-2"
				onsubmit={async (e) => {
					e.preventDefault();
					loginMsg = loginErr = null;
					const form = new FormData(e.currentTarget as HTMLFormElement);
					const body = Object.fromEntries(form.entries());
					const res = await fetch('/api/auth', {
						method: 'POST',
						headers: { 'Content-Type': 'application/json' },
						body: JSON.stringify(body)
					});
					if (res.ok) {
						loginMsg = 'Logged in. Reloading...';
						location.reload();
					} else {
						const err = await res.json().catch(() => ({}));
						loginErr = err?.error || err?.message || 'Login failed';
					}
				}}
			>
				<input name="email" type="email" placeholder="Email" required />
				<input name="password" type="password" placeholder="Password" required />
				<button type="submit">Log in</button>
			</form>
			{#if loginMsg}<p>{loginMsg}</p>{/if}
			{#if loginErr}<p>{loginErr}</p>{/if}
		</div>
		<div class="">Or <a href="/setup">setup</a> a new group</div>
	</div>
{/if}

{#if !data.user}
	<section class="flex h-screen w-screen flex-col items-center justify-center gap-y-5">
		<h2>i-c-u</h2>
		<p>Collaborative task manager, focused on appreciation and balance</p>
	</section>
{:else}
	<section class="flex flex-col gap-y-10">
		{#if (data.pendingTreats ?? []).length > 0}
			<div
				class="pointer-events-auto fixed inset-x-3 top-3 z-40 flex flex-col items-center gap-y-3"
			>
				{#each data.pendingTreats ?? [] as tr}
					<div class="rounded-xl bg-pink-100 p-4 shadow-xl">
						<div class="flex items-center gap-x-3">
							<div class="text-2xl">{(tr as any).emoji ?? '‚ô•Ô∏è'}</div>
							<div class="flex flex-col">
								<div class="text-lg">{(tr as any).title}</div>
								<div class="text-sm opacity-70">Value: {tr.valueMinutes} min</div>
							</div>
						</div>
						{#if acceptingTreatId === tr.id}
							<form
								class="mt-3 flex flex-col gap-y-2"
								onsubmit={async (e) => {
									e.preventDefault();
									const res = await fetch(`/api/treats/${tr.id}`, {
										method: 'PATCH',
										headers: { 'Content-Type': 'application/json' },
										body: JSON.stringify({
											accepted: true,
											valueMinutes: Number(acceptMinutes ?? tr.valueMinutes),
											feedbackNote: acceptFeedback || undefined
										})
									});
									if (res.ok) {
										acceptingTreatId = null;
										acceptMinutes = null;
										acceptFeedback = '';

										invalidateAll();
									}
								}}
							>
								<label class="text-sm">Confirm minutes</label>
								<input
									type="number"
									min="0"
									step="1"
									bind:value={acceptMinutes}
									placeholder={String(tr.valueMinutes)}
								/>
								<input type="text" placeholder="Optional feedback" bind:value={acceptFeedback} />
								<div class="flex gap-x-2">
									<button type="submit">Accept</button>
									<button
										type="button"
										onclick={() => {
											acceptingTreatId = null;
										}}>Cancel</button
									>
								</div>
							</form>
						{:else}
							<div class="mt-3 flex gap-x-2">
								<button
									onclick={() => {
										acceptingTreatId = tr.id;
										acceptMinutes = tr.valueMinutes;
									}}>Accept</button
								>
								<button
									onclick={async () => {
										await fetch(`/api/treats/${tr.id}`, {
											method: 'PATCH',
											headers: { 'Content-Type': 'application/json' },
											body: JSON.stringify({ accepted: false, declined: true })
										});

										invalidateAll();
									}}>Dismiss</button
								>
							</div>
						{/if}
					</div>
				{/each}
			</div>
		{/if}
		<section>
			<h2>Today</h2>
			{#if tasksToday.length === 0}
				<p class="text-3xl opacity-30">No tasks</p>
			{:else}
				<ul>
					{#each tasksToday as t}
						<li>
							<TaskItem
								task={t}
								clickComplete={() => openComplete(t)}
								clickEdit={() => openEdit(t)}
							/>
						</li>
					{/each}
				</ul>
			{/if}
		</section>
		<section>
			<h2>Upcoming</h2>
			{#if tasksUpcoming.length === 0}
				<p class="text-3xl opacity-30">No tasks</p>
			{:else}
				<ul>
					{#each tasksUpcoming as t}
						<li>
							<TaskItem
								task={t}
								clickComplete={() => openComplete(t)}
								clickEdit={() => openEdit(t)}
							/>
						</li>
					{/each}
				</ul>
			{/if}
		</section>

		<section>
			<h2>Unscheduled</h2>
			{#if tasksNoDate.length === 0}
				<p class="text-3xl opacity-30">No tasks</p>
			{:else}
				<ul>
					{#each tasksNoDate as t}
						<li>
							<TaskItem
								task={t}
								clickComplete={() => openComplete(t)}
								clickEdit={() => openEdit(t)}
							/>
						</li>
					{/each}
				</ul>
			{/if}
		</section>

		<section>
			<h2>Completed</h2>
			{#if (data.completedTasks ?? []).length === 0}
				<p class="text-3xl opacity-30">No tasks</p>
			{:else}
				<ul>
					{#each data.completedTasks ?? [] as t}
						<li>
							<TaskItem completed task={t} clickComplete={() => {}} clickEdit={() => openEdit(t)} />
						</li>
					{/each}
				</ul>
			{/if}
		</section>
	</section>

	<div class="pointer-events-none fixed inset-x-3 bottom-3 flex justify-center">
		<Button
			onclick={() => {
				editOpen = false;
				selectedTask = null;
				showAdd = true;
			}}>+</Button
		>
	</div>
{/if}

{#if showAdd}
	<div class="fixed inset-0 z-50 flex items-center justify-center bg-white/80 px-10">
		<button
			aria-label="Close"
			class="absolute inset-0 z-0 bg-black/50"
			onclick={() => (showAdd = false)}
		></button>
		<div class="relative z-10 flex flex-col gap-y-10 rounded-xl bg-black/90 p-5 text-white">
			{#if !editOpen}
				<div class="flex flex-row justify-center gap-x-4 text-3xl">
					<button
						class="{formType !== 'task' ? 'opacity-50' : ''} cursor-pointer md:hover:scale-110"
						onclick={() => (formType = 'task')}>üî® Task</button
					>
					<button
						class="{formType !== 'treat' ? 'opacity-50' : ''} cursor-pointer md:hover:scale-110"
						onclick={() => (formType = 'treat')}>‚ô•Ô∏è Treat</button
					>
				</div>
			{/if}

			{#if formType === 'task'}
				{#if editOpen}
					<TaskDialog
						task={selectedTask}
						users={data.users ?? []}
						extras={(data.tasks ?? [])
							.map((t) => t.emoji)
							.filter((e) => typeof e === 'string') as string[]}
						onCancel={() => {
							editOpen = false;
							showAdd = false;
						}}
						onSave={async (payload) => {
							let ok = false;
							if (selectedTask) {
								const res = await fetch(`/api/tasks/${selectedTask.id}`, {
									method: 'PATCH',
									headers: { 'Content-Type': 'application/json' },
									body: JSON.stringify(payload)
								});
								ok = res.ok;
							} else {
								const res = await fetch('/api/tasks', {
									method: 'POST',
									headers: { 'Content-Type': 'application/json' },
									body: JSON.stringify(payload)
								});
								ok = res.ok;
							}
							if (ok) {
								editOpen = false;

								invalidateAll();
							}
						}}
						onDelete={async () => {
							if (!selectedTask) return;
							const res = await fetch(`/api/tasks/${selectedTask.id}`, { method: 'DELETE' });
							if (res.ok) {
								editOpen = false;
								showAdd = false;

								invalidateAll();
							}
						}}
					/>
				{:else}
					<TaskDialog
						task={null}
						users={data.users ?? []}
						extras={(data.tasks ?? [])
							.map((t) => t.emoji)
							.filter((e) => typeof e === 'string') as string[]}
						onCancel={() => {
							showAdd = false;
						}}
						onSave={async (payload) => {
							addMsg = addErr = null;
							const res = await fetch('/api/tasks', {
								method: 'POST',
								headers: { 'Content-Type': 'application/json' },
								body: JSON.stringify(payload)
							});
							if (res.ok) {
								showAdd = false;

								invalidateAll();
							} else {
								addErr = 'Failed to create task';
							}
						}}
					/>
				{/if}
			{:else}
				<TreatDialog
					users={data.users ?? []}
					currentUserId={data.user?.id}
					onCancel={() => {
						showAdd = false;
					}}
					onSave={async (payload) => {
						addMsg = addErr = null;
						const res = await fetch('/api/treats', {
							method: 'POST',
							headers: { 'Content-Type': 'application/json' },
							body: JSON.stringify(payload)
						});
						if (res.ok) {
							addMsg = 'Treat created';
							showAdd = false;

							invalidateAll();
						} else {
							const err = await res.json().catch(() => ({}));
							addErr = err?.error || err?.message || 'Failed to create treat';
						}
					}}
				/>
			{/if}

			{#if addMsg}<p>{addMsg}</p>{/if}
			{#if addErr}<p>{addErr}</p>{/if}
		</div>
	</div>
{/if}

{#if completeOpen && selectedTask}
	<div>
		<h3>Complete task</h3>
		<p>{selectedTask.title}</p>
		<form
			onsubmit={async (e) => {
				e.preventDefault();
				if (selectedTask == null) return;
				const res = await fetch(`/api/tasks/${selectedTask.id}`, {
					method: 'PATCH',
					headers: { 'Content-Type': 'application/json' },
					body: JSON.stringify({
						durationMinutes: Number(completeMinutes ?? 0) || 0,
						userId: data.user?.id
					})
				});
				if (res.ok) {
					completeOpen = false;

					invalidateAll();
				}
			}}
		>
			<input type="number" min="0" step="1" placeholder="Minutes" bind:value={completeMinutes} />
			<button type="submit">Save</button>
			<button type="button" onclick={() => (completeOpen = false)}>Cancel</button>
		</form>
	</div>
{/if}
